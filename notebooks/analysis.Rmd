---
title: "RSiena Analysis"
author: "Mario Mueller"
date: "6/3/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidygraph)
library(igraph)
library(network)
library(sna)
library(intergraph)
library(RSiena)
library(multiSiena)
library(patchwork)
library(texreg)
# setwd("/Users/mariomueller/Workspace/hicss-2023")
```

# Data Preparation

## Node Sets & Composition Changes

```{r}
# Load Node Lists
devs <- read_csv("./data/nodelists/developers.csv", col_names = TRUE)
pkgs <- read_csv("./data/nodelists/packages.csv", col_names = TRUE)

# Save numbers of developers and packages for network dimensions
num_devs <- dim(devs)[1]
num_pkgs <- dim(pkgs)[1]

# Node Sets
devs <- sienaNodeSet(num_devs, nodeSetName = "devs")
pkgs <- sienaNodeSet(num_pkgs, nodeSetName = "pkgs")

# Composition Changes for both Node Sets
comp <- sienaCompositionChangeFromFile('data/compositions/comp_change.txt', nodeSet = "devs")
```

## Network

```{r}
# Load adjacency matrices
net1 <- as.matrix(read.table('data/adjacency/net-2021-02-01.txt'))
net2 <- as.matrix(read.table('data/adjacency/net-2021-03-01.txt'))
net3 <- as.matrix(read.table('data/adjacency/net-2021-04-01.txt'))
net4 <- as.matrix(read.table('data/adjacency/net-2021-05-01.txt'))

# Create network object
netList <- list(net1, net2, net3, net4)
netArray <- array(c(net1, net2, net3, net4), dim=c(num_devs, num_pkgs, length(netList)))
net <- sienaDependent(netArray, type="bipartite", nodeSet = c("devs", "pkgs"))

# Check network dimensions
lapply(netList, dim)   # each network has the same number of actors as needed
lapply(netList, function(x) table(x, useNA='always'))
```

### Plot Network

```{r}
g.layout <- gplot(apply(netArray, c(1,2), max), usearrows=T)
par(mfrow=c(1,1))
gplot(netArray[,,4], gmode="twomode",
      arrowhead.cex=.75, edge.col='gray70', coord=g.layout, vertex.cex=1.5)
```

## Individual Variables

### Packages

```{r}
# Dependencies
deps_up        <- as.matrix(read.table('data/individual/pkg_upstream.txt'))
deps_down      <- as.matrix(read.table('data/individual/pkg_downstream.txt'))
deps_up_log    <- log(deps_up + 1)
deps_down_log  <- log(deps_down + 1)
depsUpLogVar   <- varCovar(deps_up_log, nodeSet = "pkgs", centered = T) 
depsDownLogVar <- varCovar(deps_down_log, nodeSet = "pkgs", centered = T)
  
# Community Interest
com_int      <- as.matrix(read.table('data/individual/pkg_community.txt'))
com_int_log  <- log(com_int + 1)
comIntLogVar <- varCovar(com_int_log, nodeSet = "pkgs", centered = T)

# Release Activity
releases     <- as.matrix(read.table('data/individual/pkg_releases.txt'))
releases_log <- log(releases + 1)
relActLogVar <- varCovar(releases_log, nodeSet = "pkgs", centered = T)

# License
license    <- as.matrix(read.table('data/individual/pkg_license.txt'))
licenseVar <- coCovar(license[,1], nodeSet = "pkgs")

# Age
age       <- as.matrix(read.table('data/individual/pkg_age.txt'))
age_log   <- log(age)
ageLogVar <- varCovar(age_log, nodeSet = "pkgs", centered = T)
```

### Developers

```{r}
dev_act      <- as.matrix(read.table('data/individual/dev_activity.txt'))
dev_act_log  <- log(dev_act + 1)
devActLogVar <- varCovar(dev_act_log, nodeSet = "devs", centered = T)
```

## Dyadic Variables

### Upstream Dependencies

```{r}
# Dependency Associations
depUp1 <- as.matrix(read.table('data/dyadic/dep_up_associations-2021-02-01.txt'))
depUp2 <- as.matrix(read.table('data/dyadic/dep_up_associations-2021-03-01.txt'))
depUp3 <- as.matrix(read.table('data/dyadic/dep_up_associations-2021-04-01.txt'))
# Last observation not required

# Create network object
depUpList  <- list(depUp1, depUp2, depUp3)
depUpArray <- array(c(depUp1, depUp2, depUp3),
                    dim=c(num_devs, num_pkgs, length(depUpList)))
depUpDyad  <- varDyadCovar(depUpArray, nodeSets = c("devs", "pkgs"), type = "bipartite")
```

### Downstream Dependencies

```{r}
# Dependency Associations
depDown1 <- as.matrix(read.table('data/dyadic/dep_down_associations-2021-02-01.txt'))
depDown2 <- as.matrix(read.table('data/dyadic/dep_down_associations-2021-03-01.txt'))
depDown3 <- as.matrix(read.table('data/dyadic/dep_down_associations-2021-04-01.txt'))

# Create network object
depDownList  <- list(depDown1, depDown2, depDown3)
depDownArray <- array(c(depDown1, depDown2, depDown3),
                    dim=c(num_devs, num_pkgs, length(depDownList)))
depDownDyad  <- varDyadCovar(depDownArray, nodeSets = c("devs", "pkgs"), type = "bipartite")
```

## Initialization

```{r}
data <- sienaDataCreate(net, comp, devActLogVar,
                        comIntLogVar, relActLogVar, ageLogVar, licenseVar,
                        depsUpLogVar, depsDownLogVar, depUpDyad, depDownDyad,
                        nodeSets = list(devs, pkgs))
saveRDS(data, "data/sienaData.rds")
data <- readRDS("data/sienaData.rds")
print01Report(data, modelname='hicss-2023')

algorithm <- sienaAlgorithmCreate(projname='hicss-2023',
                                  seed=17,
                                  n3=3000) # 1000 standard, 3000 for publication
effects <- getEffects(data, nintn = 50)
effectsDocumentation(effects)
```

# Model Estimations

## Model 0

### Estimate

```{r}
ans.model0 <- siena07(algorithm, data=data, effects=effects,
                      batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                      byWave=T, nbrNodes=12)
siena.table(ans.model0, sig=T, type="html", file="tables/model0.html")
saveRDS(ans.model0, "models/model0.rds")
```


## Model 1

### Score-type Test

```{r}
# Rate Effect
effects1 <- effects
effects1 <- setEffect(effects1, RateX, name="net", type="rate", interaction1="devActLogVar",
                      fix=T, test=T, include=T)

# Endogenous Effects
effects1 <- setEffect(effects1, cycle4, fix=T, test=T, include=T)
effects1 <- setEffect(effects1, inPop, fix=T, test=T, include=T)
effects1 <- setEffect(effects1, outAct, fix=T, test=T, include=T)

ans.model1.stt <- siena07(algorithm, data=data, effects=effects1,
                          batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                          byWave=T, nbrNodes=12)
summary(ans.model1.stt)
saveRDS(ans.model1.stt, "models/model1.stt.rds")
```

### Estimate

```{r}
# Rate Effect
effects1 <- effects
effects1 <- setEffect(effects1, RateX, name="net", type="rate", interaction1="devActLogVar",
                      fix=F, test=F, include=T)

# Endogenous Effects
effects1 <- setEffect(effects1, cycle4, fix=F, test=F, include=T)
effects1 <- setEffect(effects1, inPop, fix=F, test=F, include=T)
effects1 <- setEffect(effects1, outAct, fix=F, test=F, include=T)

ans.model1 <- siena07(algorithm, data=data, effects=effects1,
                      batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                      byWave=T, nbrNodes=12)
summary(ans.model1)

# Wald-type test
wald1 <- Multipar.RSiena(ans.model1, c(4, 6:ans.model1$pp))

siena.table(ans.model1, sig=T, type="html", file="tables/model1.html")
saveRDS(ans.model1, "models/model1.rds")
```

## Model 2

### Score-type Test

```{r}
effects2 <- effects1

# Exogenous Effects
effects2 <- setEffect(effects2, egoX, name="net", interaction1="devActLogVar",
                      fix=T, test=T, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="comIntLogVar",
                      fix=T, test=T, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="relActLogVar",
                      fix=T, test=T, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="licenseVar",
                      fix=T, test=T, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="ageLogVar",
                      fix=T, test=T, include=T)

ans.model2.stt <- siena07(algorithm, data=data, effects=effects2,
                          batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                          byWave=T, nbrNodes=12)
summary(ans.model2.stt)
saveRDS(ans.model2.stt, "models/model2.stt.rds")
```

### Estimate

```{r}
effects2 <- effects1

# Exogenous Effects
effects2 <- setEffect(effects2, egoX, name="net", interaction1="devActLogVar",
                      fix=F, test=F, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="comIntLogVar",
                      fix=F, test=F, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="relActLogVar",
                      fix=F, test=F, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="licenseVar",
                      fix=F, test=F, include=T)
effects2 <- setEffect(effects2, altX, name="net", interaction1="ageLogVar",
                      fix=F, test=F, include=T)

ans.model2 <- siena07(algorithm, data=data, effects=effects2,
                      batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                      byWave=T, nbrNodes=12)
summary(ans.model2)

# Wald-type test
wald2 <- Multipar.RSiena(ans.model2, c((ans.model1$pp + 1):ans.model2$pp))

siena.table(ans.model2, sig=T, type="html", file="tables/model2.html")
saveRDS(ans.model2, "models/model2.rds")
```

## Model 3

### Score-type Test

```{r}
# Rate Effect
effects3 <- effects2

# Exogenous Effects
effects3 <- setEffect(effects3, altX, name="net", interaction1="depsUpLogVar",
                      fix=T, test=T, include=T)
effects3 <- setEffect(effects3, altX, name="net", interaction1="depsDownLogVar",
                      fix=T, test=T, include=T)

effects3 <- setEffect(effects3, X, name="net", interaction1="depUpDyad",
                      fix=T, test=T, include=T)
effects3 <- setEffect(effects3, X, name="net", interaction1="depDownDyad",
                      fix=T, test=T, include=T)

ans.model3.stt <- siena07(algorithm, data=data, effects=effects3,
                          batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                          byWave=T, nbrNodes=12)
summary(ans.model3.stt)
saveRDS(ans.model3.stt, "models/model3.stt.rds")
```

### Estimate

```{r}
effects3 <- effects2

# Exogenous Effects
effects3 <- setEffect(effects3, altX, name="net", interaction1="depsUpLogVar",
                      fix=F, test=F, include=T)
effects3 <- setEffect(effects3, altX, name="net", interaction1="depsDownLogVar",
                      fix=F, test=F, include=T)

effects3 <- setEffect(effects3, X, name="net", interaction1="depUpDyad",
                      fix=F, test=F, include=T)
effects3 <- setEffect(effects3, X, name="net", interaction1="depDownDyad",
                      fix=F, test=F, include=T)

ans.model3 <- siena07(algorithm, data=data, effects=effects3,
                      batch=F, verbose=F, returnDeps=T, initC=T, useCluster=T,
                      byWave=T, nbrNodes=12)
summary(ans.model3)

# Wald-type test
wald3 <- Multipar.RSiena(ans.model3, c((ans.model2$pp + 1):ans.model3$pp))

siena.table(ans.model3, sig=T, type="html", file="tables/model3.html")
saveRDS(ans.model3, "models/model3.rds")
```

# Results

```{r}
wald.string1 <- sprintf("%.2f (%d)", wald1$chisquare, wald1$df)
wald.string2 <- sprintf("%.2f (%d)", wald2$chisquare, wald2$df)
wald.string3 <- sprintf("%.2f (%d)", wald3$chisquare, wald3$df)

texreg::htmlreg(list(ans.model1, ans.model2, ans.model3),
                stars = c(0.1, 0.05, 0.01, 0.001),
                single.row = TRUE, include.iterations = FALSE,
                custom.gof.rows = list(
                  "Wald Statistics" = c(wald.string1, wald.string2, wald.string3)),
                file = 'tables/results.html')
```

# Goodness-of-Fit

## Model 0

```{r}
gof.id0 <- sienaGOF(ans.model0, varName="net", IndegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.id0)

gof.od0 <- sienaGOF(ans.model0, varName="net", OutdegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.od0)
```

## Model 1

```{r}
gof.id1 <- sienaGOF(ans.model1, varName="net", IndegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.id1)

gof.od1 <- sienaGOF(ans.model1, varName="net", OutdegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.od1)
```

## Model 2

```{r}
gof.id2 <- sienaGOF(ans.model2, varName="net", IndegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.id2)

gof.od2 <- sienaGOF(ans.model2, varName="net", OutdegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.od2)
```

## Model 3

```{r}
gof.id3 <- sienaGOF(ans.model3, varName="net", IndegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.id3)

gof.od3 <- sienaGOF(ans.model3, varName="net", OutdegreeDistribution,
                    join=T, cumulative=F, verbose=T)
plot(gof.od3)
```
